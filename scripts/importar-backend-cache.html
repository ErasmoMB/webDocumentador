<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar Cache del Backend</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .success {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #4CAF50;
            display: none;
        }
        .error {
            background: #ffebee;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #f44336;
            display: none;
        }
        input[type="file"] {
            margin: 20px 0;
            padding: 10px;
            width: 100%;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #1976D2;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì• Importar Cache del Backend</h1>
        
        <div class="info-box">
            <strong>Instrucciones:</strong><br>
            1. Selecciona el archivo JSON que exportaste del backend<br>
            2. Haz clic en "Procesar y Generar Archivos Mock"<br>
            3. Se generar√°n los archivos actualizados en la carpeta mockData<br>
            4. Copia esos archivos a: <code>webDocumentador/src/assets/mockData/</code>
        </div>

        <input type="file" id="jsonFile" accept=".json" />
        <button onclick="procesarJSON()">üîÑ Procesar y Generar Archivos Mock</button>

        <div id="resultado"></div>
    </div>

    <script>
        function procesarJSON() {
            const fileInput = document.getElementById('jsonFile');
            const file = fileInput.files[0];
            
            if (!file) {
                mostrarError('Por favor selecciona un archivo JSON');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    procesarDatos(jsonData);
                } catch (error) {
                    mostrarError('Error al leer el archivo JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function procesarDatos(data) {
            const resultadoDiv = document.getElementById('resultado');
            let archivosGenerados = [];
            let poblacionEncontrada = null;
            let peaEncontrada = null;

            try {
                // PRIMERO: Intentar desde consolidated_data
                if (data.consolidated_data) {
                    const consolidated = data.consolidated_data;

                    // Procesar poblaci√≥n consolidada (puede estar anidada o directa)
                    if (consolidated.poblacion) {
                        if (consolidated.poblacion.poblacion) {
                            // Estructura anidada: { poblacion: { poblacion: {...} } }
                            poblacionEncontrada = consolidated.poblacion.poblacion;
                        } else if (consolidated.poblacion.total_poblacion !== undefined || consolidated.poblacion.total_varones !== undefined) {
                            // Estructura directa: { poblacion: {...} }
                            poblacionEncontrada = consolidated.poblacion;
                        }
                    }

                    // Procesar PEA consolidada
                    if (consolidated.pea) {
                        peaEncontrada = consolidated.pea;
                    }
                }

                // SEGUNDO: Buscar en cache_responses si no se encontr√≥ en consolidated
                if (data.cache_responses) {
                    Object.keys(data.cache_responses).forEach(key => {
                        const respuesta = data.cache_responses[key];
                        if (respuesta.url && respuesta.data && respuesta.data.success) {
                            const responseData = respuesta.data.data;
                            
                            // Buscar poblaci√≥n por CPP (formato: { poblacion: {...} })
                            if (respuesta.url.includes('/poblacion/') && 
                                !respuesta.url.includes('/distrito') && 
                                !respuesta.url.includes('/provincia') &&
                                !poblacionEncontrada) {
                                if (responseData && responseData.poblacion) {
                                    poblacionEncontrada = responseData.poblacion;
                                    console.log('‚úÖ Poblaci√≥n encontrada en cache_responses (por CPP)');
                                }
                            }
                            
                            // Buscar PEA
                            if (respuesta.url.includes('/censo/pea-nopea') && !peaEncontrada) {
                                if (responseData) {
                                    peaEncontrada = responseData;
                                    console.log('‚úÖ PEA encontrada en cache_responses');
                                }
                            }
                        }
                    });
                }

                // Generar archivos con los datos encontrados
                if (poblacionEncontrada) {
                    const poblacionData = {
                        poblacion: convertirPoblacionBackendAMock(poblacionEncontrada)
                    };
                    archivosGenerados.push({
                        nombre: 'poblacion.json',
                        contenido: JSON.stringify(poblacionData, null, 2)
                    });
                }

                if (peaEncontrada) {
                    const peaData = {
                        pea: convertirPEABackendAMock(peaEncontrada)
                    };
                    archivosGenerados.push({
                        nombre: 'pea.json',
                        contenido: JSON.stringify(peaData, null, 2)
                    });
                }

                if (archivosGenerados.length === 0) {
                    mostrarError('No se encontraron datos v√°lidos para procesar');
                    return;
                }

                // Generar archivos
                let html = '<div class="success"><strong>‚úÖ Archivos generados:</strong><br><br>';
                archivosGenerados.forEach(archivo => {
                    html += `<strong>${archivo.nombre}</strong><br>`;
                    html += `<pre>${archivo.contenido}</pre><br>`;
                    
                    // Crear link de descarga
                    const blob = new Blob([archivo.contenido], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = archivo.nombre;
                    link.textContent = `üì• Descargar ${archivo.nombre}`;
                    link.style.display = 'inline-block';
                    link.style.margin = '10px';
                    link.style.padding = '10px 15px';
                    link.style.background = '#4CAF50';
                    link.style.color = 'white';
                    link.style.textDecoration = 'none';
                    link.style.borderRadius = '5px';
                    
                    const linkContainer = document.createElement('div');
                    linkContainer.appendChild(link);
                    html += linkContainer.outerHTML;
                    html += '<br>';
                });
                
                html += '<br><strong>üìã Instrucciones:</strong><br>';
                html += '1. Descarga los archivos JSON generados arriba<br>';
                html += '2. Reemplaza los archivos en: <code>webDocumentador/src/assets/mockData/</code><br>';
                html += '3. Recarga tu aplicaci√≥n Angular';
                html += '</div>';

                resultadoDiv.innerHTML = html;

                // Auto-descargar archivos
                archivosGenerados.forEach(archivo => {
                    setTimeout(() => {
                        const blob = new Blob([archivo.contenido], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = archivo.nombre;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 500);
                });

            } catch (error) {
                mostrarError('Error al procesar datos: ' + error.message);
            }
        }

        function convertirPoblacionBackendAMock(poblacionBackend) {
            // Convertir formato del backend al formato mock
            return {
                totalPobladores: poblacionBackend.total_poblacion || 0,
                totalMujeres: poblacionBackend.total_mujeres || 0,
                totalVarones: poblacionBackend.total_varones || 0,
                porcentajeMujeres: poblacionBackend.porcentaje_mujeres || "0%",
                porcentajeVarones: poblacionBackend.porcentaje_varones || "0%",
                de0a14: poblacionBackend.edad_0_14 || 0,
                de0a14Porcentaje: calcularPorcentaje(poblacionBackend.edad_0_14, poblacionBackend.total_poblacion),
                de14a29: poblacionBackend.edad_15_29 || 0,
                de14a29Porcentaje: calcularPorcentaje(poblacionBackend.edad_15_29, poblacionBackend.total_poblacion),
                de30a44: poblacionBackend.edad_30_44 || 0,
                de30a44Porcentaje: calcularPorcentaje(poblacionBackend.edad_30_44, poblacionBackend.total_poblacion),
                de45a64: poblacionBackend.edad_45_64 || 0,
                de45a64Porcentaje: calcularPorcentaje(poblacionBackend.edad_45_64, poblacionBackend.total_poblacion),
                de65amas: poblacionBackend.edad_65_mas || 0,
                de65amasPorcentaje: calcularPorcentaje(poblacionBackend.edad_65_mas, poblacionBackend.total_poblacion)
            };
        }

        function convertirPEABackendAMock(peaBackend) {
            return {
                totalPEA: peaBackend.pea || 0,
                peaOcupada: peaBackend.ocupada || 0,
                peaDesocupada: peaBackend.desocupada || 0,
                porcentajeOcupada: peaBackend.porcentaje_ocupada || "0%",
                porcentajeDesocupada: peaBackend.porcentaje_desocupada || "0%",
                actividades: peaBackend.actividades || []
            };
        }

        function calcularPorcentaje(valor, total) {
            if (!total || total === 0) return "0.00";
            return ((valor / total) * 100).toFixed(2);
        }

        function mostrarError(mensaje) {
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.innerHTML = `<div class="error"><strong>‚ùå Error:</strong> ${mensaje}</div>`;
        }
    </script>
</body>
</html>

