<div class="seccion-container">
  <div class="seccion-preview" [style.flex]="previewFlex">
    <div class="preview-header">
      <div class="preview-header-titles">
        <h3 *ngIf="seccionPadreTitulo" class="seccion-padre-titulo">{{ seccionPadreTitulo }}</h3>
        <h2>{{ seccionTitulo }}</h2>
      </div>
      <div class="preview-actions">
        <button class="btn btn-clear" (click)="limpiarDatos()" title="Limpiar todos los datos guardados">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12c0 1.66-1.34 3-3 3H6c-1.66 0-3-1.34-3-3s1.34-3 3-3h12c1.66 0 3 1.34 3 3z"/>
            <path d="M9 9V6c0-1.1.9-2 2-2h2c1.1 0 2 .9 2 2v3"/>
            <path d="M12 9v9"/>
            <path d="M8 9h8"/>
          </svg>
          Limpiar
        </button>
        <button class="btn btn-test" (click)="llenarDatosPrueba()" title="Llenar todos los campos con datos de prueba">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          Llenar Prueba
        </button>
        <button class="btn btn-ghost" (click)="irAPlantilla()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
          Ver Plantilla Completa
        </button>
      </div>
    </div>
    <div class="preview-content scrollbar-thin">
      <div class="preview-document">
        <!-- Usar componente seccion1 para la sección 3.1.1 -->
        <div class="preview preview-static" *ngIf="seccionId === '3.1.1'">
          <div class="viewport-content">
            <app-seccion1 [seccionId]="seccionId"></app-seccion1>
          </div>
        </div>
        <!-- Usar componente seccion2 para la sección 3.1.2, 3.1.2.A y 3.1.2.B -->
        <div class="preview preview-static" *ngIf="seccionId === '3.1.2' || seccionId === '3.1.2.A' || seccionId === '3.1.2.B'">
          <div class="viewport-content">
            <app-seccion2 [seccionId]="seccionId"></app-seccion2>
          </div>
        </div>
        <!-- Usar componente seccion3 para la sección 3.1.3 -->
        <div class="preview preview-static" *ngIf="seccionId === '3.1.3' || seccionId === '3.1.3.A' || seccionId === '3.1.3.B'">
          <div class="viewport-content">
            <app-seccion3 [seccionId]="seccionId"></app-seccion3>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.A' || seccionId === '3.1.4.A.1' || seccionId === '3.1.4.A.2'">
          <div class="viewport-content">
            <app-seccion4 [seccionId]="seccionId" [modoFormulario]="false"></app-seccion4>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 1)">
          <div class="viewport-content">
            <app-seccion5 [seccionId]="seccionId"></app-seccion5>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 2)">
          <div class="viewport-content">
            <app-seccion6 [seccionId]="seccionId"></app-seccion6>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 3)">
          <div class="viewport-content">
            <app-seccion7 [seccionId]="seccionId"></app-seccion7>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 4)">
          <div class="viewport-content">
            <app-seccion8 [seccionId]="seccionId"></app-seccion8>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 5)">
          <div class="viewport-content">
            <app-seccion9 [seccionId]="seccionId"></app-seccion9>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 6)">
          <div class="viewport-content">
            <app-seccion10 [seccionId]="seccionId"></app-seccion10>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 7)">
          <div class="viewport-content">
            <app-seccion11 [seccionId]="seccionId"></app-seccion11>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 8)">
          <div class="viewport-content">
            <app-seccion12 [seccionId]="seccionId"></app-seccion12>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 9)">
          <div class="viewport-content">
            <app-seccion13 [seccionId]="seccionId"></app-seccion13>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 10)">
          <div class="viewport-content">
            <app-seccion14 [seccionId]="seccionId"></app-seccion14>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 11)">
          <div class="viewport-content">
            <app-seccion15 [seccionId]="seccionId"></app-seccion15>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 12)">
          <div class="viewport-content">
            <app-seccion16 [seccionId]="seccionId"></app-seccion16>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 13)">
          <div class="viewport-content">
            <app-seccion17 [seccionId]="seccionId"></app-seccion17>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 14)">
          <div class="viewport-content">
            <app-seccion18 [seccionId]="seccionId"></app-seccion18>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 15)">
          <div class="viewport-content">
            <app-seccion19 [seccionId]="seccionId"></app-seccion19>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="esSubseccionAISD(seccionId, 16)">
          <div class="viewport-content">
            <app-seccion20 [seccionId]="seccionId"></app-seccion20>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B' || seccionId === '3.1.4.B.1' || seccionId === '3.1.4.B.2'">
          <div class="viewport-content">
            <app-seccion21></app-seccion21>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.1' || seccionId === '3.1.4.B.2.1'">
          <div class="viewport-content">
            <app-seccion22 [seccionId]="seccionId"></app-seccion22>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.2' || seccionId === '3.1.4.B.2.2'">
          <div class="viewport-content">
            <app-seccion23 [seccionId]="seccionId"></app-seccion23>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.3' || seccionId === '3.1.4.B.2.3'">
          <div class="viewport-content">
            <app-seccion24 [seccionId]="seccionId"></app-seccion24>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.4' || seccionId === '3.1.4.B.2.4'">
          <div class="viewport-content">
            <app-seccion25 [seccionId]="seccionId"></app-seccion25>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.5' || seccionId === '3.1.4.B.2.5'">
          <div class="viewport-content">
            <app-seccion26 [seccionId]="seccionId"></app-seccion26>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.6' || seccionId === '3.1.4.B.2.6'">
          <div class="viewport-content">
            <app-seccion27 [seccionId]="seccionId"></app-seccion27>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.7' || seccionId === '3.1.4.B.2.7'">
          <div class="viewport-content">
            <app-seccion28 [seccionId]="seccionId"></app-seccion28>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.8' || seccionId === '3.1.4.B.2.8'">
          <div class="viewport-content">
            <app-seccion29 [seccionId]="seccionId"></app-seccion29>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.9' || seccionId === '3.1.4.B.2.9'">
          <div class="viewport-content">
            <app-seccion30 [seccionId]="seccionId"></app-seccion30>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.10' || seccionId === '3.1.4.B.2.10'">
          <div class="viewport-content">
            <app-seccion31 [seccionId]="seccionId"></app-seccion31>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.11' || seccionId === '3.1.4.B.2.11'">
          <div class="viewport-content">
            <app-seccion32 [seccionId]="seccionId"></app-seccion32>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.12' || seccionId === '3.1.4.B.2.12'">
          <div class="viewport-content">
            <app-seccion33 [seccionId]="seccionId"></app-seccion33>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.13' || seccionId === '3.1.4.B.2.13'">
          <div class="viewport-content">
            <app-seccion34 [seccionId]="seccionId"></app-seccion34>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.14' || seccionId === '3.1.4.B.2.14'">
          <div class="viewport-content">
            <app-seccion35 [seccionId]="seccionId"></app-seccion35>
          </div>
        </div>
        <div class="preview preview-static" *ngIf="seccionId === '3.1.4.B.1.15' || seccionId === '3.1.4.B.2.15'">
          <div class="viewport-content">
            <app-seccion36 [seccionId]="seccionId"></app-seccion36>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="resizer" (mousedown)="startResize($event)" 
       [class.resizing]="isResizing"
       title="Arrastra para redimensionar"></div>

  <div class="seccion-formulario" [style.flex]="formularioFlex">
    <div class="formulario-header">
      <h3>Formulario de Datos</h3>
      <span class="badge badge-primary">{{ seccionTitulo }}</span>
    </div>
    <div class="formulario-content scrollbar-thin">
      <!-- Formulario especializado para 3.1.1 y 3.1.2 -->
      <ng-container *ngIf="seccionId === '3.1.1' || seccionId === '3.1.2' || seccionId === '3.1.2.A' || seccionId === '3.1.2.B'">
        <div class="form-group-section" *ngIf="seccionId === '3.1.1'">
          <h4 class="section-title">Información del Proyecto</h4>
          
          <div class="form-field">
            <label class="label">Nombre del Proyecto <span class="required">*</span></label>
            <input 
              type="text" 
              class="input" 
              placeholder="Ej: Paka"
              [value]="formData['projectName'] || ''"
              (input)="onFieldChange('projectName', $any($event.target).value)">
          </div>
        </div>

        <div class="form-group-section" *ngIf="seccionId === '3.1.1'">
          <h4 class="section-title">Cargar Datos de Centros Poblados</h4>
          
          <div class="form-field">
            <label class="label">Subir UBIGEO de Centro Poblado <span class="required">*</span></label>
            <div class="file-upload-wrapper">
              <input 
                type="file" 
                id="jsonFileInput" 
                accept=".json" 
                (change)="onJSONFileSelected($event)"
                style="display: none;">
              <button 
                type="button" 
                class="btn btn-secondary" 
                (click)="selectJSONFile()">
                Seleccionar archivo
              </button>
              <span *ngIf="jsonFileName" class="file-name">{{ jsonFileName }}</span>
              <span *ngIf="!jsonFileName" class="file-name">Ningún archivo seleccionado</span>
            </div>
            <small class="form-hint">Seleccione un archivo JSON con datos de centros poblados</small>
          </div>

          <div class="form-field" *ngIf="centrosPobladosJSON.length > 0">
            <label class="label">Información Geográfica</label>
            <div class="form-row">
              <div class="form-field">
                <label class="label">Departamento <span class="required">*</span></label>
                <input 
                  type="text" 
                  class="input" 
                  [value]="formData['departamentoSeleccionado'] || geoInfo.DPTO || ''"
                  [readonly]="!!geoInfo.DPTO"
                  (input)="onFieldChange('departamentoSeleccionado', $any($event.target).value)">
              </div>
              <div class="form-field">
                <label class="label">Provincia <span class="required">*</span></label>
                <input 
                  type="text" 
                  class="input" 
                  [value]="formData['provinciaSeleccionada'] || geoInfo.PROV || ''"
                  [readonly]="!!geoInfo.PROV"
                  (input)="onFieldChange('provinciaSeleccionada', $any($event.target).value)">
              </div>
              <div class="form-field">
                <label class="label">Distrito <span class="required">*</span></label>
                <input 
                  type="text" 
                  class="input" 
                  [value]="formData['distritoSeleccionado'] || geoInfo.DIST || ''"
                  [readonly]="!!geoInfo.DIST"
                  (input)="onFieldChange('distritoSeleccionado', $any($event.target).value)">
              </div>
            </div>
            <small class="form-hint">Esta información se completa automáticamente desde el JSON</small>
          </div>
        </div>

        <app-seccion1 *ngIf="seccionId === '3.1.1'" [seccionId]="seccionId" [modoFormulario]="true"></app-seccion1>

        <div class="form-group-section" *ngIf="seccionId === '3.1.2' || seccionId === '3.1.2.A' || seccionId === '3.1.2.B'">
          <h4 class="section-title">Delimitación de Áreas de Influencia Social</h4>
          
          <div *ngFor="let comunidad of comunidadesCampesinas; let i = index" 
               style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9;">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h5 style="margin: 0; color: #333;">Comunidad Campesina {{ i + 1 }}</h5>
              <button 
                type="button" 
                class="btn btn-danger" 
                (click)="eliminarComunidadCampesina(comunidad.id)"
                style="font-size: 12px; padding: 5px 10px;"
                *ngIf="comunidadesCampesinas.length > 1">
                Eliminar
              </button>
            </div>

            <div class="form-field" *ngIf="centrosPobladosJSON.length > 0">
              <label class="label">Seleccionar Centros Poblados para AISD <span class="required">*</span></label>
              <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button 
                  type="button" 
                  class="btn btn-secondary" 
                  (click)="seleccionarTodosCentrosPobladosComunidad(comunidad.id)" 
                  style="font-size: 12px; padding: 5px 10px;">
                  Seleccionar Todos
                </button>
                <button 
                  type="button" 
                  class="btn btn-secondary" 
                  (click)="deseleccionarTodosCentrosPobladosComunidad(comunidad.id)" 
                  style="font-size: 12px; padding: 5px 10px;">
                  Deseleccionar Todos
                </button>
              </div>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: white;">
                <div *ngFor="let cp of centrosPobladosJSON" 
                     style="display: flex; align-items: center; padding: 5px 0; border-bottom: 1px solid #f0f0f0;">
                  <input 
                    type="checkbox" 
                    [checked]="estaCentroPobladoSeleccionadoComunidad(comunidad.id, cp.CODIGO?.toString() || '')"
                    (change)="toggleCentroPobladoComunidad(comunidad.id, cp.CODIGO?.toString() || '')"
                    style="margin-right: 8px;">
                  <span style="flex: 1;">{{ cp.CCPP }}</span>
                </div>
              </div>
              <small class="form-hint">Seleccione los centros poblados que formarán parte del AISD. Debe seleccionar al menos uno.</small>
            </div>

            <div class="form-field">
              <label class="label">Comunidad Campesina (CC) AISD <span class="required">*</span></label>
              <input 
                type="text" 
                class="input" 
                placeholder="Ingrese el nombre de la comunidad campesina"
                [value]="comunidad.nombre"
                (input)="actualizarNombreComunidad(comunidad.id, $any($event.target).value)"
                [disabled]="obtenerCentrosPobladosSeleccionadosComunidad(comunidad.id).length === 0">
              <small class="form-hint">Asigne un nombre a la Comunidad Campesina. Primero seleccione los centros poblados.</small>
            </div>
          </div>

          <div style="margin-top: 20px;">
            <button 
              type="button" 
              class="btn btn-primary" 
              (click)="agregarComunidadCampesina()"
              style="font-size: 14px; padding: 10px 20px;">
              + Agregar Otra Comunidad Campesina
            </button>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label class="label">Distrito Adicional 1</label>
              <div class="autocomplete-wrapper">
                <input 
                  type="text" 
                  class="input" 
                  placeholder="Buscar distrito adicional..."
                  [value]="((autocompleteData['aisdComponente1'] && autocompleteData['aisdComponente1'].buscado) || formData['aisdComponente1'] || '')"
                  (input)="onAutocompleteInput('aisdComponente1', $any($event.target).value)"
                  (focus)="onFocusDistritoAdicional('aisdComponente1')"
                  [disabled]="false">
                
                <div *ngIf="autocompleteData['aisdComponente1'] && autocompleteData['aisdComponente1'].mostrar && autocompleteData['aisdComponente1'].sugerencias.length > 0" 
                     class="autocomplete-dropdown"
                     (mouseenter)="autocompleteData['aisdComponente1'].mostrar = true"
                     (mouseleave)="cerrarSugerenciasAutocomplete('aisdComponente1')">
                  <div 
                    *ngFor="let sugerencia of autocompleteData['aisdComponente1'].sugerencias" 
                    class="autocomplete-item"
                    (mousedown)="seleccionarSugerencia('aisdComponente1', sugerencia)"
                    (click)="seleccionarSugerencia('aisdComponente1', sugerencia)">
                    {{ sugerencia }}
                  </div>
                </div>
              </div>
              <small class="form-hint">Busca distritos de la provincia seleccionada</small>
            </div>
            <div class="form-field">
              <label class="label">Distrito Adicional 2</label>
              <div class="autocomplete-wrapper">
                <input 
                  type="text" 
                  class="input" 
                  placeholder="Buscar distrito adicional..."
                  [value]="((autocompleteData['aisdComponente2'] && autocompleteData['aisdComponente2'].buscado) || formData['aisdComponente2'] || '')"
                  (input)="onAutocompleteInput('aisdComponente2', $any($event.target).value)"
                  (focus)="onFocusDistritoAdicional('aisdComponente2')"
                  [disabled]="false">
                
                <div *ngIf="autocompleteData['aisdComponente2'] && autocompleteData['aisdComponente2'].mostrar && autocompleteData['aisdComponente2'].sugerencias.length > 0" 
                     class="autocomplete-dropdown"
                     (mouseenter)="autocompleteData['aisdComponente2'].mostrar = true"
                     (mouseleave)="cerrarSugerenciasAutocomplete('aisdComponente2')">
                  <div 
                    *ngFor="let sugerencia of autocompleteData['aisdComponente2'].sugerencias" 
                    class="autocomplete-item"
                    (mousedown)="seleccionarSugerencia('aisdComponente2', sugerencia)"
                    (click)="seleccionarSugerencia('aisdComponente2', sugerencia)">
                    {{ sugerencia }}
                  </div>
                </div>
              </div>
              <small class="form-hint">Busca distritos de la provincia seleccionada</small>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- Formulario para IDH (Sección 17) y NBI (Sección 18) -->
      <ng-container *ngIf="seccionId?.includes('3.1.4.A.1.13') || seccionId?.includes('3.1.4.A.2.13') || seccionId?.includes('3.1.4.B.1.13') || seccionId?.includes('3.1.4.B.2.13') || seccionId?.includes('3.1.4.A.1.14') || seccionId?.includes('3.1.4.A.2.14') || seccionId?.includes('3.1.4.B.1.14') || seccionId?.includes('3.1.4.B.2.14')">
        <div class="form-group-section">
          <h4 class="section-title" *ngIf="seccionId?.includes('3.1.4.A.1.13') || seccionId?.includes('3.1.4.A.2.13') || seccionId?.includes('3.1.4.B.1.13') || seccionId?.includes('3.1.4.B.2.13')">Fotografías de Índice de Desarrollo Humano (IDH)</h4>
          <h4 class="section-title" *ngIf="seccionId?.includes('3.1.4.A.1.14') || seccionId?.includes('3.1.4.A.2.14') || seccionId?.includes('3.1.4.B.1.14') || seccionId?.includes('3.1.4.B.2.14')">Fotografías de Necesidades Básicas Insatisfechas (NBI)</h4>
          
          <div class="form-field" *ngIf="seccionId?.includes('3.1.4.A.1.13') || seccionId?.includes('3.1.4.A.2.13') || seccionId?.includes('3.1.4.B.1.13') || seccionId?.includes('3.1.4.B.2.13')">
            <label class="label">Fotografías de IDH</label>
            <app-image-upload
              [fotografias]="fotografiasIDHFormMulti"
              [sectionId]="seccionId"
              [photoPrefix]="'fotografiaIDH'"
              [permitirMultiples]="true"
              labelTitulo="Título de la fotografía"
              labelFuente="Fuente de la fotografía"
              labelImagen="Fotografía - Imagen"
              placeholderTitulo="Ej: Índice de Desarrollo Humano"
              placeholderFuente="Ej: GEADES, 2024"
              tituloDefault="Índice de Desarrollo Humano"
              fuenteDefault="GEADES, 2024"
              (fotografiasChange)="onFotografiasIDHChange($event)">
            </app-image-upload>
          </div>

          <div class="form-field" *ngIf="seccionId?.includes('3.1.4.A.1.14') || seccionId?.includes('3.1.4.A.2.14') || seccionId?.includes('3.1.4.B.1.14') || seccionId?.includes('3.1.4.B.2.14')">
            <label class="label">Fotografías de NBI</label>
            <app-image-upload
              [fotografias]="fotografiasNBIFormMulti"
              [sectionId]="seccionId"
              [photoPrefix]="'fotografiaNBI'"
              [permitirMultiples]="true"
              labelTitulo="Título de la fotografía"
              labelFuente="Fuente de la fotografía"
              labelImagen="Fotografía - Imagen"
              placeholderTitulo="Ej: Necesidades Básicas Insatisfechas"
              placeholderFuente="Ej: GEADES, 2024"
              tituloDefault="Necesidades Básicas Insatisfechas"
              fuenteDefault="GEADES, 2024"
              (fotografiasChange)="onFotografiasNBIChange($event)">
            </app-image-upload>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="seccionId === '3.1.2' || seccionId === '3.1.2.A' || seccionId === '3.1.2.B'">
        <app-seccion2 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion2>
      </ng-container>

      <!-- Formulario especializado para 3.1.4.B, 3.1.4.B.1 y 3.1.4.B.2 -->
      <ng-container *ngIf="seccionId === '3.1.4.B' || seccionId === '3.1.4.B.1' || seccionId === '3.1.4.B.2'">
        <app-seccion21 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion21>
      </ng-container>

      <!-- Formulario especializado para 3.1.3, 3.1.3.A y 3.1.3.B -->
      <ng-container *ngIf="seccionId === '3.1.3' || seccionId === '3.1.3.A' || seccionId === '3.1.3.B'">
        <app-seccion3 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion3>
      </ng-container>

      <!-- Formulario especializado para 3.1.4, 3.1.4.A y 3.1.4.A.1 -->
      <ng-container *ngIf="seccionId === '3.1.4' || seccionId === '3.1.4.A' || seccionId === '3.1.4.A.1' || seccionId === '3.1.4.A.2'">
        <!-- Información General de la Comunidad -->
        <div class="form-group-section">
          <h4 class="section-title">Información General de la Comunidad</h4>
          
          <div class="form-field">
            <label class="label">Distrito Principal <span class="required">*</span></label>
            <select 
              *ngIf="obtenerDistritosDeComunidad().length > 1"
              class="input" 
              [value]="formData['distritoSeleccionado'] || ''"
              (change)="onDistritoPrincipalChange($any($event.target).value)">
              <option value="">Seleccione un distrito</option>
              <option *ngFor="let distrito of obtenerDistritosDeComunidad()" [value]="distrito">{{ distrito }}</option>
            </select>
            <input 
              *ngIf="obtenerDistritosDeComunidad().length === 1"
              type="text" 
              class="input" 
              [value]="formData['distritoSeleccionado'] || obtenerDistritosDeComunidad()[0] || ''"
              [disabled]="true">
            <small class="form-hint" *ngIf="obtenerDistritosDeComunidad().length > 1">Seleccione el distrito principal de la comunidad</small>
            <small class="form-hint" *ngIf="obtenerDistritosDeComunidad().length === 1">Distrito único de la comunidad</small>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label class="label">Coordenadas</label>
              <input type="text" class="input" placeholder="Ej: 18L E: 660 619 m N: 8 291 173 m" 
                [value]="formData['coordenadasAISD'] || ''"
                (input)="onFieldChange('coordenadasAISD', $any($event.target).value)">
            </div>
            <div class="form-field">
              <label class="label">Altitud (msnm) <span class="required">*</span></label>
              <input type="text" class="input" placeholder="Ej: 3 599" 
                [value]="formData['altitudAISD'] || ''"
                (input)="onAltitudChange($any($event.target).value)"
                (blur)="normalizarAltitud()">
            </div>
          </div>
        </div>

        <app-seccion4 *ngIf="seccionId === '3.1.4.A' || seccionId === '3.1.4.A.1' || seccionId === '3.1.4.A.2'" [seccionId]="seccionId" [modoFormulario]="true"></app-seccion4>

        <!-- Cuadro 1: Ubicación referencial -->
        <div class="form-group-section">
          <h4 class="section-title">Cuadro 1: Ubicación referencial</h4>
          <div class="form-field">
            <label class="label">Título <span class="required">*</span></label>
            <input type="text" class="input" placeholder="Ej: Ubicación referencial" 
              [value]="formData['cuadroTituloAISD1'] || ''"
              (input)="onFieldChange('cuadroTituloAISD1', $any($event.target).value)">
          </div>
          <div class="form-field">
            <label class="label">Fuente <span class="required">*</span></label>
            <input type="text" class="input" placeholder="Ej: GEADES (2024)" 
              [value]="formData['cuadroFuenteAISD1'] || ''"
              (input)="onFieldChange('cuadroFuenteAISD1', $any($event.target).value)">
          </div>
          <small class="form-hint">El número de cuadro se genera automáticamente. Los demás campos (Localidad, Distrito, Provincia, Departamento) se completan automáticamente desde la información general</small>
        </div>

        <!-- Cuadro 2: Población y viviendas -->
        <div class="form-group-section">
          <h4 class="section-title">Cuadro 2: Población y viviendas</h4>
          <div class="form-field">
            <label class="label">Título <span class="required">*</span></label>
            <input type="text" class="input" placeholder="Ej: Cantidad total de población y viviendas" 
              [value]="formData['cuadroTituloAISD2'] || ''"
              (input)="onFieldChange('cuadroTituloAISD2', $any($event.target).value)">
          </div>
          <!-- Tabla editable dinámica -->
          <div class="table-editor">
            <table class="editor-table">
              <thead>
                <tr>
                  <th>Punto de Población</th>
                  <th>Código</th>
                  <th>Población</th>
                  <th>Viviendas Empadronadas</th>
                  <th>Viviendas Ocupadas</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of getFilasTabla(); let i = index">
                  <td>
                    <div class="autocomplete-wrapper">
                      <input type="text" class="table-input" 
                        [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'Punto') || ''"
                        (input)="onPuntoPoblacionInput(i+1, $any($event.target).value)"
                        (blur)="onPuntoPoblacionBlur(i+1)"
                        placeholder="Buscar punto de población...">
                      <div *ngIf="autocompleteData['puntoPoblacion' + (i+1)] && autocompleteData['puntoPoblacion' + (i+1)].mostrar && autocompleteData['puntoPoblacion' + (i+1)].sugerencias.length > 0" 
                           class="autocomplete-dropdown"
                           (mouseenter)="autocompleteData['puntoPoblacion' + (i+1)].mostrar = true"
                           (mouseleave)="cerrarSugerenciasAutocomplete('puntoPoblacion' + (i+1))">
                        <div 
                          *ngFor="let sugerencia of autocompleteData['puntoPoblacion' + (i+1)].sugerencias" 
                          class="autocomplete-item"
                          (mousedown)="seleccionarPuntoPoblacion(i+1, sugerencia)"
                          (click)="seleccionarPuntoPoblacion(i+1, sugerencia)">
                          {{ sugerencia.nombre }} ({{ sugerencia.codigo }})
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <input type="text" class="table-input" 
                      [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'Codigo') || ''"
                      (input)="onTablaFieldChange('tablaAISD2Fila' + (i+1) + 'Codigo', $any($event.target).value)"
                      placeholder="____">
                  </td>
                  <td>
                    <input type="text" class="table-input" 
                      [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'Poblacion') || ''"
                      (input)="onTablaFieldChange('tablaAISD2Fila' + (i+1) + 'Poblacion', $any($event.target).value)"
                      placeholder="____">
                  </td>
                  <td>
                    <input type="text" class="table-input" 
                      [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'ViviendasEmpadronadas') || ''"
                      (input)="onTablaFieldChange('tablaAISD2Fila' + (i+1) + 'ViviendasEmpadronadas', $any($event.target).value)"
                      placeholder="____">
                  </td>
                  <td>
                    <input type="text" class="table-input" 
                      [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'ViviendasOcupadas') || ''"
                      (input)="onTablaFieldChange('tablaAISD2Fila' + (i+1) + 'ViviendasOcupadas', $any($event.target).value)"
                      placeholder="____">
                  </td>
                  <td>
                    <button type="button" class="btn-icon" (click)="eliminarFilaTabla(i)" *ngIf="filasTablaAISD2 > 1" title="Eliminar fila">
                      ×
                    </button>
                  </td>
                </tr>
                <tr class="total-row">
                  <td><strong>Total</strong></td>
                  <td></td>
                  <td>
                    <input type="text" class="table-input" 
                      [value]="obtenerValorConPrefijo('tablaAISD2TotalPoblacion') || '0'"
                      readonly
                      style="background-color: #f5f5f5; cursor: not-allowed;">
                  </td>
                  <td>
                    <input type="text" class="table-input" 
                      [value]="obtenerValorConPrefijo('tablaAISD2TotalViviendasEmpadronadas') || '0'"
                      readonly
                      style="background-color: #f5f5f5; cursor: not-allowed;">
                  </td>
                  <td>
                    <input type="text" class="table-input" 
                      [value]="obtenerValorConPrefijo('tablaAISD2TotalViviendasOcupadas') || '0'"
                      readonly
                      style="background-color: #f5f5f5; cursor: not-allowed;">
                  </td>
                  <td></td>
                </tr>
              </tbody>
            </table>
            <button type="button" class="btn btn-secondary" (click)="agregarFilaTabla()" style="margin-top: 10px;">
              + Agregar Fila
            </button>
          </div>
          <div class="form-field">
            <label class="label">Fuente <span class="required">*</span></label>
            <input type="text" class="input" placeholder="Ej: Reporte de Indicadores... REDINFORMA (MIDIS)" 
              [value]="formData['cuadroFuenteAISD2'] || ''"
              (input)="onFieldChange('cuadroFuenteAISD2', $any($event.target).value)">
          </div>
          <small class="form-hint">El número de cuadro se genera automáticamente</small>
        </div>

        <!-- Fotografías Sección 4 -->
        <div class="form-group-section">
          <h4 class="section-title">Fotografías de Sección 4</h4>
          <app-image-upload
            [fotografias]="fotografiasAISDFormMulti"
            [sectionId]="seccionId"
            [permitirMultiples]="true"
            labelTitulo="Título de la fotografía"
            labelFuente="Fuente de la fotografía"
            labelImagen="Fotografía - Imagen"
            placeholderTitulo="Ej: Fotografía de la sección 4"
            placeholderFuente="Ej: GEADES, 2024"
            tituloDefault="Sección 4"
            fuenteDefault="GEADES, 2024"
            (fotografiasChange)="onFotografiasAISDChange($event)">
          </app-image-upload>
        </div>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 1)">
        <app-seccion5 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion5>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 2)">
        <app-seccion6 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion6>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 3)">
        <app-seccion7 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion7>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 3)">
        <div class="form-group-section">
          <h4 class="section-title">A.1.3. Aspectos Económicos - Campos Adicionales</h4>
          
          <div class="form-field">
            <label class="label">Población Distrital</label>
            <input type="text" class="input" placeholder="Ej: 610"
              [value]="formData['poblacionDistritalCahuacho'] || ''"
              (input)="onFieldChange('poblacionDistritalCahuacho', $any($event.target).value)"
              readonly>
            <small class="form-hint">Se carga automáticamente desde el backend</small>
          </div>
          
          <div class="form-field">
            <label class="label">PET Distrital (14 años a más)</label>
            <input type="text" class="input" placeholder="Ej: 461"
              [value]="formData['petDistritalCahuacho'] || ''"
              (input)="onFieldChange('petDistritalCahuacho', $any($event.target).value)"
              readonly>
            <small class="form-hint">Se carga automáticamente desde el backend</small>
          </div>
          
          <div class="form-field">
            <label class="label">Ingreso Familiar Per Cápita (S/.)</label>
            <input type="text" class="input" placeholder="Ej: 391,06"
              [value]="formData['ingresoFamiliarPerCapita'] || ''"
              (input)="onFieldChange('ingresoFamiliarPerCapita', $any($event.target).value)">
          </div>
          
          <div class="form-field">
            <label class="label">Ranking Ingreso Per Cápita</label>
            <input type="text" class="input" placeholder="Ej: 1191"
              [value]="formData['rankingIngresoPerCapita'] || ''"
              (input)="onFieldChange('rankingIngresoPerCapita', $any($event.target).value)">
          </div>
          <div class="form-field">
            <label class="label">Tabla PET según grupos de edad</label>
            <div class="table-editor">
              <p class="note">Esta tabla se gestiona a través del componente de fotografía institucional</p>
            </div>
          </div>
          <div class="form-field">
            <label class="label">Tabla PEA y No PEA según sexo</label>
            <div class="table-editor">
              <p class="note">Esta tabla se gestiona a través del componente de fotografía institucional</p>
            </div>
          </div>
          <div class="form-field">
            <label class="label">Tabla PEA Ocupada y Desocupada según sexo</label>
            <div class="table-editor">
              <table class="editor-table">
                <thead>
                  <tr>
                    <th>Categoría</th>
                    <th>Hombres</th>
                    <th>% Hombres</th>
                    <th>Mujeres</th>
                    <th>% Mujeres</th>
                    <th>Casos</th>
                    <th>Porcentaje</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of (datos['peaOcupadaTabla'] || []); let i = index">
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.categoria || ''"
                        (input)="actualizarPEAOcupada(i, 'categoria', $any($event.target).value)"
                        placeholder="PEA Ocupada/Desocupada">
                    </td>
                    <td>
                      <input type="number" class="table-input" 
                        [value]="item.hombres || ''"
                        (input)="actualizarPEAOcupada(i, 'hombres', $any($event.target).value)"
                        placeholder="0">
                    </td>
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.porcentajeHombres || ''"
                        (input)="actualizarPEAOcupada(i, 'porcentajeHombres', $any($event.target).value)"
                        placeholder="0%">
                    </td>
                    <td>
                      <input type="number" class="table-input" 
                        [value]="item.mujeres || ''"
                        (input)="actualizarPEAOcupada(i, 'mujeres', $any($event.target).value)"
                        placeholder="0">
                    </td>
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.porcentajeMujeres || ''"
                        (input)="actualizarPEAOcupada(i, 'porcentajeMujeres', $any($event.target).value)"
                        placeholder="0%">
                    </td>
                    <td>
                      <input type="number" class="table-input" 
                        [value]="item.casos || ''"
                        (input)="actualizarPEAOcupada(i, 'casos', $any($event.target).value)"
                        placeholder="0">
                    </td>
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.porcentaje || ''"
                        (input)="actualizarPEAOcupada(i, 'porcentaje', $any($event.target).value)"
                        placeholder="0%">
                    </td>
                    <td>
                      <button type="button" class="btn-icon" (click)="eliminarPEAOcupada(i)" *ngIf="(datos['peaOcupadaTabla'] || []).length > 1 && item.categoria !== 'Total'" title="Eliminar fila">
                        ×
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="!datos['peaOcupadaTabla'] || datos['peaOcupadaTabla'].length === 0">
                    <td colspan="8" style="text-align: center; padding: 10px;">
                      <button type="button" class="btn btn-secondary" (click)="inicializarPEAOcupada()">
                        Agregar Filas
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-secondary" (click)="agregarPEAOcupada()" style="margin-top: 10px;">
              + Agregar Fila
            </button>
          </div>

        </div>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 4)">
        <app-seccion8 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion8>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 5)">
        <app-seccion9 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion9>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 6)">
        <app-seccion10 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion10>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 7)">
        <app-seccion11 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion11>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 8)">
        <app-seccion12 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion12>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 9)">
        <app-seccion13 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion13>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 10)">
        <div class="form-group-section">
          <h4 class="section-title">A.1.10. Indicadores de educación</h4>
          <div class="form-field">
            <label class="label">Tabla Nivel Educativo de la Población</label>
            <div class="table-editor">
              <table class="editor-table">
                <thead>
                  <tr>
                    <th>Categoría</th>
                    <th>Casos</th>
                    <th>Porcentaje</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of (datos['nivelEducativoTabla'] || []); let i = index">
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.categoria || ''"
                        (input)="actualizarNivelEducativo(i, 'categoria', $any($event.target).value)"
                        placeholder="Sin nivel o Inicial">
                    </td>
                    <td>
                      <input type="number" class="table-input" 
                        [value]="item.casos || ''"
                        (input)="actualizarNivelEducativo(i, 'casos', $any($event.target).value)"
                        placeholder="0">
                    </td>
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.porcentaje || ''"
                        (input)="actualizarNivelEducativo(i, 'porcentaje', $any($event.target).value)"
                        placeholder="0%">
                    </td>
                    <td>
                      <button type="button" class="btn-icon" (click)="eliminarNivelEducativo(i)" *ngIf="((datos['nivelEducativoTabla'] || []).length > 1) && item.categoria !== 'Total'" title="Eliminar fila">
                        ×
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="!datos['nivelEducativoTabla'] || datos['nivelEducativoTabla'].length === 0">
                    <td colspan="4" style="text-align: center; padding: 10px;">
                      <button type="button" class="btn btn-secondary" (click)="inicializarNivelEducativo()">
                        Agregar Primera Fila
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-secondary" (click)="agregarNivelEducativo()" style="margin-top: 10px;">
              + Agregar Fila
            </button>
          </div>
          <div class="form-field">
            <label class="label">Tabla Tasa de Analfabetismo</label>
            <div class="table-editor">
              <table class="editor-table">
                <thead>
                  <tr>
                    <th>Indicador</th>
                    <th>Casos</th>
                    <th>Porcentaje</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of (datos['tasaAnalfabetismoTabla'] || []); let i = index">
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.indicador || ''"
                        (input)="actualizarTasaAnalfabetismo(i, 'indicador', $any($event.target).value)"
                        placeholder="Sabe leer y escribir">
                    </td>
                    <td>
                      <input type="number" class="table-input" 
                        [value]="item.casos || ''"
                        (input)="actualizarTasaAnalfabetismo(i, 'casos', $any($event.target).value)"
                        placeholder="0">
                    </td>
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.porcentaje || ''"
                        (input)="actualizarTasaAnalfabetismo(i, 'porcentaje', $any($event.target).value)"
                        placeholder="0%">
                    </td>
                    <td>
                      <button type="button" class="btn-icon" (click)="eliminarTasaAnalfabetismo(i)" *ngIf="((datos['tasaAnalfabetismoTabla'] || []).length > 1) && item.indicador !== 'Total'" title="Eliminar fila">
                        ×
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="!datos['tasaAnalfabetismoTabla'] || datos['tasaAnalfabetismoTabla'].length === 0">
                    <td colspan="4" style="text-align: center; padding: 10px;">
                      <button type="button" class="btn btn-secondary" (click)="inicializarTasaAnalfabetismo()">
                        Agregar Primera Fila
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-secondary" (click)="agregarTasaAnalfabetismo()" style="margin-top: 10px;">
              + Agregar Fila
            </button>
          </div>

          <div class="form-field">
            <label class="label">Fotografías de Indicadores de Educación</label>
            <app-image-upload
              [fotografias]="fotografiasEducacionIndicadoresFormMulti"
              [sectionId]="seccionId"
              [photoPrefix]="'fotografiaEducacionIndicadores'"
              [permitirMultiples]="true"
              labelTitulo="Título de la fotografía"
              labelFuente="Fuente de la fotografía"
              labelImagen="Fotografía - Imagen"
              placeholderTitulo="Ej: Indicadores de educación en la CC Ayroca"
              placeholderFuente="Ej: GEADES, 2024"
              tituloDefault="Indicadores de educación"
              fuenteDefault="GEADES, 2024"
              (fotografiasChange)="onFotografiasEducacionIndicadoresChange($event)">
            </app-image-upload>
          </div>

          <div class="form-group-section" *ngIf="esSubseccionAISD(seccionId, 10)">
            <h4 class="section-title">Editar Párrafos</h4>
            
            <div class="form-field">
              <label class="label">Introducción - Indicadores de Educación</label>
              <textarea 
                class="textarea" 
                rows="4"
                [value]="obtenerTextoSeccion14IndicadoresEducacionIntro()"
                (input)="onFieldChange('parrafoSeccion14_indicadores_educacion_intro', $any($event.target).value)"></textarea>
              <small class="form-hint">Edite el texto completo. Deje vacío para usar el texto por defecto.</small>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 11)">
        <div class="form-group-section">
          <h4 class="section-title">A.1.11. Aspectos culturales (lenguas, dialectos, lugares)</h4>
          <div class="form-field">
            <label class="label">Tabla Lenguas Maternas</label>
            <div class="table-editor">
              <table class="editor-table">
                <thead>
                  <tr>
                    <th>Categoría</th>
                    <th>Casos</th>
                    <th>Porcentaje</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of (datos['lenguasMaternasTabla'] || []); let i = index">
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.categoria || ''"
                        (input)="actualizarLenguasMaternas(i, 'categoria', $any($event.target).value)"
                        placeholder="Castellano">
                    </td>
                    <td>
                      <input type="number" class="table-input" 
                        [value]="item.casos || ''"
                        (input)="actualizarLenguasMaternas(i, 'casos', $any($event.target).value)"
                        placeholder="0">
                    </td>
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.porcentaje || ''"
                        (input)="actualizarLenguasMaternas(i, 'porcentaje', $any($event.target).value)"
                        placeholder="0%">
                    </td>
                    <td>
                      <button type="button" class="btn-icon" (click)="eliminarLenguasMaternas(i)" *ngIf="((datos['lenguasMaternasTabla'] || []).length > 1) && item.categoria !== 'Total'" title="Eliminar fila">
                        ×
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="!datos['lenguasMaternasTabla'] || datos['lenguasMaternasTabla'].length === 0">
                    <td colspan="4" style="text-align: center; padding: 10px;">
                      <button type="button" class="btn btn-secondary" (click)="inicializarLenguasMaternas()">
                        Agregar Primera Fila
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-secondary" (click)="agregarLenguasMaternas()" style="margin-top: 10px;">
              + Agregar Fila
            </button>
          </div>
          <div class="form-field">
            <label class="label">Tabla Religiones</label>
            <div class="table-editor">
              <table class="editor-table">
                <thead>
                  <tr>
                    <th>Categoría</th>
                    <th>Casos</th>
                    <th>Porcentaje</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of (datos['religionesTabla'] || []); let i = index">
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.categoria || ''"
                        (input)="actualizarReligiones(i, 'categoria', $any($event.target).value)"
                        placeholder="Católica">
                    </td>
                    <td>
                      <input type="number" class="table-input" 
                        [value]="item.casos || ''"
                        (input)="actualizarReligiones(i, 'casos', $any($event.target).value)"
                        placeholder="0">
                    </td>
                    <td>
                      <input type="text" class="table-input" 
                        [value]="item.porcentaje || ''"
                        (input)="actualizarReligiones(i, 'porcentaje', $any($event.target).value)"
                        placeholder="0%">
                    </td>
                    <td>
                      <button type="button" class="btn-icon" (click)="eliminarReligiones(i)" *ngIf="((datos['religionesTabla'] || []).length > 1) && item.categoria !== 'Total'" title="Eliminar fila">
                        ×
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="!datos['religionesTabla'] || datos['religionesTabla'].length === 0">
                    <td colspan="4" style="text-align: center; padding: 10px;">
                      <button type="button" class="btn btn-secondary" (click)="inicializarReligiones()">
                        Agregar Primera Fila
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-secondary" (click)="agregarReligiones()" style="margin-top: 10px;">
              + Agregar Fila
            </button>
          </div>
          <div class="form-field">
            <label class="label">Fotografías de la Iglesia</label>
            <app-image-upload
              [fotografias]="fotografiasIglesiaFormMulti"
              [sectionId]="seccionId"
              [photoPrefix]="'fotografiaIglesia'"
              [permitirMultiples]="true"
              labelTitulo="Título de la fotografía"
              labelFuente="Fuente de la fotografía"
              labelImagen="Fotografía - Imagen"
              placeholderTitulo="Ej: Iglesia Matriz del anexo Ayroca"
              placeholderFuente="Ej: GEADES, 2024"
              tituloDefault="Iglesia Matriz del anexo Ayroca"
              fuenteDefault="GEADES, 2024"
              [requerido]="true"
              (fotografiasChange)="onFotografiasIglesiaChange($event)">
            </app-image-upload>
          </div>

          <div class="form-group-section" *ngIf="esSubseccionAISD(seccionId, 11)">
            <h4 class="section-title">Editar Párrafos</h4>
            
            <div class="form-field">
              <label class="label">Religión - Texto Completo</label>
              <textarea 
                class="textarea" 
                rows="4"
                [value]="obtenerTextoSeccion15ReligionCompleto()"
                (input)="onFieldChange('parrafoSeccion15_religion_completo', $any($event.target).value)"></textarea>
              <small class="form-hint">Edite el texto completo. Deje vacío para usar el texto por defecto.</small>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 12)">
        <div class="form-group-section">
          <h4 class="section-title">A.1.12. Uso de los suelos y de los recursos naturales</h4>
          <div class="form-row">
            <div class="form-field">
              <label class="label">Ojo de Agua 1</label>
              <input type="text" class="input" placeholder="Ej: Quinsa Rumi"
                [value]="formData['ojosAgua1'] || ''"
                (input)="onFieldChange('ojosAgua1', $any($event.target).value)">
            </div>
            <div class="form-field">
              <label class="label">Ojo de Agua 2</label>
              <input type="text" class="input" placeholder="Ej: Pallalli"
                [value]="formData['ojosAgua2'] || ''"
                (input)="onFieldChange('ojosAgua2', $any($event.target).value)">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label class="label">Río Agrícola</label>
              <input type="text" class="input" placeholder="Ej: Yuracyacu"
                [value]="formData['rioAgricola'] || ''"
                (input)="onFieldChange('rioAgricola', $any($event.target).value)">
            </div>
            <div class="form-field">
              <label class="label">Quebrada Agrícola</label>
              <input type="text" class="input" placeholder="Ej: Pucaccocha"
                [value]="formData['quebradaAgricola'] || ''"
                (input)="onFieldChange('quebradaAgricola', $any($event.target).value)">
            </div>
          </div>
          <div class="form-field">
            <label class="label">Fotografías del Reservorio</label>
            <app-image-upload
              [fotografias]="fotografiasReservorioFormMulti"
              [sectionId]="seccionId"
              [photoPrefix]="'fotografiaReservorio'"
              [permitirMultiples]="true"
              labelTitulo="Título de la fotografía"
              labelFuente="Fuente de la fotografía"
              labelImagen="Fotografía - Imagen"
              placeholderTitulo="Ej: Reservorio del anexo Ayroca"
              placeholderFuente="Ej: GEADES, 2024"
              tituloDefault="Reservorio del anexo Ayroca"
              fuenteDefault="GEADES, 2024"
              [requerido]="true"
              (fotografiasChange)="onFotografiasReservorioChange($event)">
            </app-image-upload>
          </div>
          <div class="form-field">
            <label class="label">Fotografías de Uso de Suelos</label>
            <app-image-upload
              [fotografias]="fotografiasUsoSuelosFormMulti"
              [sectionId]="seccionId"
              [photoPrefix]="'fotografiaUsoSuelos'"
              [permitirMultiples]="true"
              labelTitulo="Título de la fotografía"
              labelFuente="Fuente de la fotografía"
              labelImagen="Fotografía - Imagen"
              placeholderTitulo="Ej: Uso de los suelos en el anexo Ayroca"
              placeholderFuente="Ej: GEADES, 2024"
              tituloDefault="Uso de los suelos en el anexo Ayroca"
              fuenteDefault="GEADES, 2024"
              [requerido]="true"
              (fotografiasChange)="onFotografiasUsoSuelosChange($event)">
            </app-image-upload>
          </div>

          <div class="form-group-section" *ngIf="esSubseccionAISD(seccionId, 12)">
            <h4 class="section-title">Editar Párrafos</h4>
            
            <div class="form-field">
              <label class="label">Fuentes y Usos del Agua - Texto Completo</label>
              <textarea 
                class="textarea" 
                rows="6"
                [value]="obtenerTextoSeccion16AguaCompleto()"
                (input)="onFieldChange('parrafoSeccion16_agua_completo', $any($event.target).value)"></textarea>
              <small class="form-hint">Edite todo el bloque de texto sobre fuentes y usos del agua. Use Enter para crear nuevos párrafos. Deje vacío para usar el texto por defecto.</small>
            </div>

            <div class="form-field">
              <label class="label">Tenencia de la Tierra y Recursos Naturales - Texto Completo</label>
              <textarea 
                class="textarea" 
                rows="8"
                [value]="obtenerTextoSeccion16RecursosNaturalesCompleto()"
                (input)="onFieldChange('parrafoSeccion16_recursos_naturales_completo', $any($event.target).value)"></textarea>
              <small class="form-hint">Edite todo el bloque de texto sobre tenencia de la tierra y recursos naturales. Use Enter para crear nuevos párrafos. Deje vacío para usar el texto por defecto.</small>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="esSubseccionAISD(seccionId, 13)">
        <app-seccion17 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion17>
      </ng-container>


      <ng-container *ngIf="esSubseccionAISD(seccionId, 14)">
        <app-seccion18 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion18>
      </ng-container>


      <ng-container *ngIf="esSubseccionAISD(seccionId, 15)">
        <app-seccion19 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion19>
      </ng-container>


      <ng-container *ngIf="esSubseccionAISD(seccionId, 16)">
        <app-seccion20 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion20>
      </ng-container>


      <ng-container *ngIf="seccionId === '3.1.4.B.1.1' || seccionId === '3.1.4.B.2.1'">
        <app-seccion22 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion22>
      </ng-container>


      <ng-container *ngIf="seccionId === '3.1.4.B.1.2' || seccionId === '3.1.4.B.2.2'">
        <app-seccion23 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion23>
      </ng-container>

      <ng-container *ngIf="seccionId === '3.1.4.B.1.3' || seccionId === '3.1.4.B.2.3'">
        <app-seccion24 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion24>
      </ng-container>

      <ng-container *ngIf="seccionId === '3.1.4.B.1.4' || seccionId === '3.1.4.B.2.4'">
        <app-seccion25 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion25>
      </ng-container>

      <ng-container *ngIf="seccionId === '3.1.4.B.1.5' || seccionId === '3.1.4.B.2.5'">
        <app-seccion26 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion26>
      </ng-container>

      <ng-container *ngIf="seccionId === '3.1.4.B.1.6' || seccionId === '3.1.4.B.2.6'">
        <app-seccion27 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion27>
      </ng-container>

      <ng-container *ngIf="seccionId === '3.1.4.B.1.7' || seccionId === '3.1.4.B.2.7'">
        <app-seccion28 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion28>
      </ng-container>

      <ng-container *ngIf="seccionId === '3.1.4.B.1.8' || seccionId === '3.1.4.B.2.8'">
        <app-seccion29 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion29>
      </ng-container>

      <ng-container *ngIf="seccionId === '3.1.4.B.1.9' || seccionId === '3.1.4.B.2.9'">
        <app-seccion30 [seccionId]="seccionId" [modoFormulario]="true"></app-seccion30>
        
        <div class="form-group-section" *ngIf="seccionId === '3.1.4.B.1.9' || seccionId === '3.1.4.B.2.9'">
          <h4 class="section-title">Editar Párrafos</h4>
          
          <div class="form-field">
            <label class="label">Introducción - Indicadores de Educación</label>
            <textarea 
              class="textarea" 
              rows="4"
              [value]="obtenerTextoSeccion30IndicadoresEducacionIntro()"
              (input)="onFieldChange('parrafoSeccion30_indicadores_educacion_intro', $any($event.target).value)"></textarea>
            <small class="form-hint">Edite el texto completo. Deje vacío para usar el texto por defecto.</small>
          </div>
        </div>
      </ng-container>

    </div>

    <div class="formulario-footer">
      <button class="btn btn-ghost" (click)="seccionAnterior()" [disabled]="!puedeIrAnterior">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Anterior
      </button>
      <button *ngIf="!esUltimaSeccion" class="btn btn-primary" (click)="seccionSiguiente()" [disabled]="!puedeIrSiguiente">
        Siguiente
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
      </button>
      <button *ngIf="esUltimaSeccion" class="btn btn-primary" (click)="irAPlantilla()">
        Ver Plantilla
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
      </button>
    </div>
  </div>
</div>

