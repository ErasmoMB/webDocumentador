<div class="table-editor">
  <table class="table table--editable editor-table">
    <thead>
      <!-- Encabezado agrupado (opcional) -->
      <tr *ngIf="groupHeaders && groupHeaders.length">
        <th *ngFor="let g of groupHeaders" [attr.colspan]="g.colspan" style="text-align:center">{{ g.label }}</th>
        <th *ngIf="showDeleteButton && !modoVista" rowspan="2"></th>
      </tr>
      <tr>
        <th *ngFor="let col of columns">{{ col.label }}</th>
        <th *ngIf="!groupHeaders && showDeleteButton && !modoVista"></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of getEditableRows(); let i = index; trackBy: trackByIndex" [class]="getRowClasses(item)">
        <td *ngFor="let col of columns; let colIndex = index" 
            [attr.data-label]="col.label"
            [attr.rowspan]="(col.field === 'categoria' && item?.esEncabezadoGrupo) ? getRowspan(i, col.field) : null"
            [style.display]="(col.field === 'categoria' && item?.esSubcategoria) ? 'none' : ''"
            [class.categoria-agrupada]="col.field === 'categoria' && item?.esEncabezadoGrupo">
          <!-- Modo vista: mostrar solo texto -->
          <span *ngIf="modoVista">{{ getFormattedValue(item, col) }}</span>
          <!-- Modo edición: elementos interactivos -->
          <ng-container *ngIf="!modoVista">
            <!-- Select para SI/NO y otros tipos de selección -->
            <select
              *ngIf="col.type === 'select'"
              class="table-input"
              [value]="getFormattedValue(item, col)"
              (change)="onFieldChange(i, col.field, $any($event.target).value)"
              [disabled]="isFieldReadonly(col, i)">
              <option value="">-- Seleccionar --</option>
              <option *ngFor="let value of col.allowedValues" [value]="value">{{ value }}</option>
            </select>
            <!-- Textarea para campos de tipo textarea -->
            <textarea 
              *ngIf="col.type === 'textarea'"
              class="table-input table-textarea"
              [value]="getFormattedValue(item, col)"
              (blur)="onFieldChange(i, col.field, $any($event.target).value)"
              [placeholder]="col.placeholder || ''"
              [readonly]="isFieldReadonly(col, i)"
              rows="2">
            </textarea>
            <!-- Input para otros tipos -->
            <input 
              *ngIf="col.type !== 'textarea' && col.type !== 'select'"
              [type]="col.type || 'text'"
              class="table-input"
              [value]="getFormattedValue(item, col)"
              (blur)="onFieldChange(i, col.field, $any($event.target).value)"
              (keyup.enter)="onFieldChange(i, col.field, $any($event.target).value); $any($event.target).blur()"
              [placeholder]="col.placeholder || ''"
              [readonly]="isFieldReadonly(col, i)">
          </ng-container>
        </td>
        <td *ngIf="showDeleteButton && !modoVista" class="table-actions" data-label="">
          <button 
            type="button" 
            class="btn-icon" 
            (click)="onDelete(i)" 
            *ngIf="canDelete(i) && !modoVista && (config?.permiteEliminarFilas !== false)"
            title="Eliminar fila">
            ×
          </button>
        </td>
      </tr>
      <tr *ngIf="(!tableData || tableData.length === 0) && !modoVista && showAddButton">
        <td [attr.colspan]="columns.length + (showDeleteButton ? 1 : 0)" class="text-center p-md">
          <button type="button" class="btn btn-secondary" (click)="onAdd()">
            Agregar Fila
          </button>
        </td>
      </tr>
      <!-- Fila de Total (readonly) -->
      <tr *ngIf="getTotalRow() && !modoVista" class="total-row">
        <td *ngFor="let col of columns" [attr.data-label]="col.label">
          <span *ngIf="modoVista">{{ getFormattedValue(getTotalRow(), col) }}</span>
          <ng-container *ngIf="!modoVista">
            <input 
              [type]="col.type || 'text'"
              class="table-input"
              [value]="getFormattedValue(getTotalRow(), col)"
              readonly
              style="background-color: #f5f5f5; cursor: not-allowed;">
          </ng-container>
        </td>
        <td *ngIf="showDeleteButton && !modoVista" class="table-actions" data-label="">
          <!-- No hay botón de eliminar para la fila Total -->
        </td>
      </tr>
    </tbody>
  </table>
  <button 
    *ngIf="showAddButton && (tableData && tableData.length > 0) && !modoVista && (config?.permiteAgregarFilas !== false)"
    type="button" 
    class="btn btn-secondary mt-sm" 
    (click)="onAdd()">
    + Agregar Fila
  </button>
</div>
