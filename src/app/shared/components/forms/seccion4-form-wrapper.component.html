<div class="form-group-section">
  <h4 class="section-title">Información General de la Comunidad</h4>
  
  <div class="form-field">
    <label class="label">Distrito Principal <span class="required">*</span></label>
    <select 
      *ngIf="obtenerDistritosDeComunidad().length > 1"
      class="input" 
      [value]="formData['distritoSeleccionado'] || ''"
      (change)="onDistritoPrincipalChange($any($event.target).value)">
      <option value="">Seleccione un distrito</option>
      <option *ngFor="let distrito of obtenerDistritosDeComunidad()" [value]="distrito">{{ distrito }}</option>
    </select>
    <input 
      *ngIf="obtenerDistritosDeComunidad().length === 1"
      type="text" 
      class="input" 
      [value]="formData['distritoSeleccionado'] || obtenerDistritosDeComunidad()[0] || ''"
      [disabled]="true">
    <small class="form-hint" *ngIf="obtenerDistritosDeComunidad().length > 1">Seleccione el distrito principal de la comunidad</small>
    <small class="form-hint" *ngIf="obtenerDistritosDeComunidad().length === 1">Distrito único de la comunidad</small>
  </div>

  <div class="form-row">
    <div class="form-field">
      <label class="label">Coordenadas</label>
      <input type="text" class="input" placeholder="Ej: 18L E: 660 619 m N: 8 291 173 m" 
        [value]="formData['coordenadasAISD'] || ''"
        (input)="onFieldChange('coordenadasAISD', $any($event.target).value)">
    </div>
    <div class="form-field">
      <label class="label">Altitud (msnm) <span class="required">*</span></label>
      <input type="text" class="input" placeholder="Ej: 3 599" 
        [value]="formData['altitudAISD'] || ''"
        (input)="onAltitudChange($any($event.target).value)"
        (blur)="normalizarAltitud()">
    </div>
  </div>
</div>

<app-seccion4 *ngIf="seccionId === '3.1.4.A' || seccionId === '3.1.4.A.1' || seccionId === '3.1.4.A.2'" [seccionId]="seccionId" [modoFormulario]="true"></app-seccion4>

<div class="form-group-section">
  <h4 class="section-title">Cuadro 1: Ubicación referencial</h4>
  <div class="form-field">
    <label class="label">Título <span class="required">*</span></label>
    <input type="text" class="input" placeholder="Ej: Ubicación referencial" 
      [value]="formData['cuadroTituloAISD1'] || ''"
      (input)="onFieldChange('cuadroTituloAISD1', $any($event.target).value)">
  </div>
  <div class="form-field">
    <label class="label">Fuente <span class="required">*</span></label>
    <input type="text" class="input" placeholder="Ej: GEADES (2024)" 
      [value]="formData['cuadroFuenteAISD1'] || ''"
      (input)="onFieldChange('cuadroFuenteAISD1', $any($event.target).value)">
  </div>
  <small class="form-hint">El número de cuadro se genera automáticamente. Los demás campos (Localidad, Distrito, Provincia, Departamento) se completan automáticamente desde la información general</small>
</div>

<div class="form-group-section">
  <h4 class="section-title">Cuadro 2: Población y viviendas</h4>
  <div class="form-field">
    <label class="label">Título <span class="required">*</span></label>
    <input type="text" class="input" placeholder="Ej: Cantidad total de población y viviendas" 
      [value]="formData['cuadroTituloAISD2'] || ''"
      (input)="onFieldChange('cuadroTituloAISD2', $any($event.target).value)">
  </div>
  <div class="table-editor">
    <table class="editor-table">
      <thead>
        <tr>
          <th>Punto de Población</th>
          <th>Código</th>
          <th>Población</th>
          <th>Viviendas Empadronadas</th>
          <th>Viviendas Ocupadas</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of getFilasTabla(); let i = index">
          <td>
            <div class="autocomplete-wrapper">
              <input type="text" class="table-input" 
                [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'Punto') || ''"
                (input)="onPuntoPoblacionInput(i+1, $any($event.target).value)"
                (blur)="onPuntoPoblacionBlur(i+1)"
                placeholder="Buscar punto de población...">
              <div *ngIf="autocompleteData['puntoPoblacion' + (i+1)] && autocompleteData['puntoPoblacion' + (i+1)].mostrar && autocompleteData['puntoPoblacion' + (i+1)].sugerencias.length > 0" 
                   class="autocomplete-dropdown"
                   (mouseenter)="autocompleteData['puntoPoblacion' + (i+1)].mostrar = true"
                   (mouseleave)="cerrarSugerenciasAutocomplete('puntoPoblacion' + (i+1))">
                <div 
                  *ngFor="let sugerencia of autocompleteData['puntoPoblacion' + (i+1)].sugerencias" 
                  class="autocomplete-item"
                  (mousedown)="seleccionarPuntoPoblacion(i+1, sugerencia)"
                  (click)="seleccionarPuntoPoblacion(i+1, sugerencia)">
                  {{ sugerencia.nombre }} ({{ sugerencia.codigo }})
                </div>
              </div>
            </div>
          </td>
          <td>
            <input type="text" class="table-input" 
              [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'Codigo') || ''"
              (input)="onTablaFieldChange('tablaAISD2Fila' + (i+1) + 'Codigo', $any($event.target).value)"
              placeholder="____">
          </td>
          <td>
            <input type="text" class="table-input" 
              [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'Poblacion') || ''"
              (input)="onTablaFieldChange('tablaAISD2Fila' + (i+1) + 'Poblacion', $any($event.target).value)"
              placeholder="____">
          </td>
          <td>
            <input type="text" class="table-input" 
              [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'ViviendasEmpadronadas') || ''"
              (input)="onTablaFieldChange('tablaAISD2Fila' + (i+1) + 'ViviendasEmpadronadas', $any($event.target).value)"
              placeholder="____">
          </td>
          <td>
            <input type="text" class="table-input" 
              [value]="obtenerValorConPrefijo('tablaAISD2Fila' + (i+1) + 'ViviendasOcupadas') || ''"
              (input)="onTablaFieldChange('tablaAISD2Fila' + (i+1) + 'ViviendasOcupadas', $any($event.target).value)"
              placeholder="____">
          </td>
          <td>
            <button type="button" class="btn-icon" (click)="eliminarFilaTabla(i)" *ngIf="filasTablaAISD2 > 1" title="Eliminar fila">
              ×
            </button>
          </td>
        </tr>
        <tr class="total-row">
          <td><strong>Total</strong></td>
          <td></td>
          <td>
            <input type="text" class="table-input" 
              [value]="obtenerValorConPrefijo('tablaAISD2TotalPoblacion') || '0'"
              readonly
              style="background-color: #f5f5f5; cursor: not-allowed;">
          </td>
          <td>
            <input type="text" class="table-input" 
              [value]="obtenerValorConPrefijo('tablaAISD2TotalViviendasEmpadronadas') || '0'"
              readonly
              style="background-color: #f5f5f5; cursor: not-allowed;">
          </td>
          <td>
            <input type="text" class="table-input" 
              [value]="obtenerValorConPrefijo('tablaAISD2TotalViviendasOcupadas') || '0'"
              readonly
              style="background-color: #f5f5f5; cursor: not-allowed;">
          </td>
          <td></td>
        </tr>
      </tbody>
    </table>
    <button type="button" class="btn btn-secondary" (click)="agregarFilaTabla()" style="margin-top: 10px;">
      + Agregar Fila
    </button>
  </div>
  <div class="form-field">
    <label class="label">Fuente <span class="required">*</span></label>
    <input type="text" class="input" placeholder="Ej: Reporte de Indicadores... REDINFORMA (MIDIS)" 
      [value]="formData['cuadroFuenteAISD2'] || ''"
      (input)="onFieldChange('cuadroFuenteAISD2', $any($event.target).value)">
  </div>
  <small class="form-hint">El número de cuadro se genera automáticamente</small>
</div>

<div class="form-group-section">
  <h4 class="section-title">Fotografías de Sección 4</h4>
  <app-image-upload
    [fotografias]="fotografiasAISDFormMulti"
    [sectionId]="seccionId"
    [permitirMultiples]="true"
    labelTitulo="Título de la fotografía"
    labelFuente="Fuente de la fotografía"
    labelImagen="Fotografía - Imagen"
    placeholderTitulo="Ej: Fotografía de la sección 4"
    placeholderFuente="Ej: GEADES, 2024"
    tituloDefault="Sección 4"
    fuenteDefault="GEADES, 2024"
    (fotografiasChange)="onFotografiasAISDChange($event)">
  </app-image-upload>
</div>
