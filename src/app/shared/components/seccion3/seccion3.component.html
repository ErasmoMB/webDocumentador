<div *ngIf="!modoFormulario">
<h3>3.1.3 Índices demográficos, sociales, económicos, de ocupación laboral
    y otros similares</h3>
<div>
  <div *ngIf="viewModel().data.parrafoSeccion3_metodologia; else metodologiaDefault" class="text-justify" [innerHTML]="formatearParrafo(viewModel().data.parrafoSeccion3_metodologia)"></div>
  <ng-template #metodologiaDefault>
      <p class="text-justify">Para la descripción del aspecto socioeconómico se ha utilizado
          una combinación de métodos y técnicas cualitativas de investigación social, entre ellas se ha seleccionado
          las técnicas de entrevistas semiestructuradas con autoridades locales y/o informantes calificados, así como
          de encuestas de carácter socioeconómico. Además de ello, se ha recurrido a la recopilación de documentos que
          luego son contrastados y completados con la consulta de diversas fuentes de información oficiales
          actualizadas respecto al área de influencia social tales como el Censo Nacional INEI (2017), Escale –
          MINEDU, la base de datos de la Oficina General de Estadística e Informática del Ministerio de Salud, entre
          otros.</p>
  </ng-template>
  <h4>A. Fuentes primarias</h4>
  <div *ngIf="viewModel().data.parrafoSeccion3_fuentes_primarias; else fuentesPrimariasDefault" class="text-justify" [innerHTML]="formatearParrafo(viewModel().data.parrafoSeccion3_fuentes_primarias)"></div>
  <ng-template #fuentesPrimariasDefault>
      <p class="text-justify">Dentro de las fuentes primarias se consideran a las autoridades comunales y locales, así como pobladores que fueron entrevistados y proporcionaron información cualitativa y cuantitativa. Esta información de primera mano muestra datos fidedignos que proporcionan un alcance más cercano de la realidad en la que se desarrollan las poblaciones del área de influencia social. Para la obtención de información cualitativa, se realizaron un total de <span [appDataSource]="getDataSourceType('cantidadEntrevistas')" [fieldName]="'cantidadEntrevistas'">{{ viewModel().data.cantidadEntrevistas || '____' }}</span> entrevistas en profundidad a informantes calificados y autoridades locales.</p>
  </ng-template>
  <p class="text-justify">A continuación, se muestra en el siguiente cuadro los cargos u
      ocupaciones principales de las <span [appDataSource]="getDataSourceType('cantidadEntrevistas')" [fieldName]="'cantidadEntrevistas'">{{ viewModel().data.cantidadEntrevistas || '____' }}</span>
      autoridades e
      informantes que fueron entrevistados durante el trabajo de campo llevado a cabo en el mes de <span
          [appDataSource]="getDataSourceType('fechaTrabajoCampo')" [fieldName]="'fechaTrabajoCampo'">{{ viewModel().data.fechaTrabajoCampo || '____' }}</span>. </p>
  <app-table-wrapper title="Lista de entrevistados" sectionId="3.1.3">
    <app-generic-table
      [data]="entrevistadosSignal()"
      [config]="{
        columns: [
          { key: 'nombre', header: 'Nombres y Apellidos', align: 'left' },
          { key: 'cargo', header: 'Cargo u Ocupación', align: 'left' },
          { key: 'organizacion', header: 'Organización', align: 'left' }
        ],
        showFooter: false,
        striped: true,
        hover: true
      }"
      (tableUpdated)="onEntrevistadosTableUpdated()">
    </app-generic-table>
  </app-table-wrapper>
  <p class="text-justify">Fuente: <span [appDataSource]="getDataSourceType('consultora')" [fieldName]="'consultora'">{{ viewModel().data.consultora || 'GEADES (2024)' }}</span></p>
  <h4>B. Fuentes secundarias</h4>
  <div class="text-justify" [innerHTML]="formatearParrafo(obtenerIntroFuentes())"></div>
  <ul *ngIf="viewModel().data.fuentesSecundariasLista && viewModel().data.fuentesSecundariasLista.length > 0">
      <li class="list-item" *ngFor="let fuente of viewModel().data.fuentesSecundariasLista">{{ fuente }}</li>
  </ul>

<app-image-upload
    [modoVista]="true"
    [permitirMultiples]="true"
    [fotografias]="fotografiasSeccion3"
    [sectionId]="seccionId"
    [photoPrefix]="PHOTO_PREFIX"
    [labelTitulo]="'Título'"
    [labelFuente]="'Fuente'"
    [labelImagen]="'Imagen'">
</app-image-upload>
</div>

<div *ngIf="modoFormulario" class="seccion-formulario-content">
  <div class="form-group-section">
    <h4 class="section-title" style="margin-top: 20px;">Editar Párrafos</h4>

    <app-paragraph-editor
      fieldId="parrafoSeccion3_metodologia"
      label="Metodología"
      hint="Edite el texto completo. Deje vacío para usar el texto por defecto."
      [rows]="3"
      [value]="viewModel().data.parrafoSeccion3_metodologia || ''"
      (valueChange)="onFieldChange('parrafoSeccion3_metodologia', $event)">
    </app-paragraph-editor>

    <app-paragraph-editor
      fieldId="parrafoSeccion3_fuentes_primarias"
      label="A. Fuentes Primarias"
      hint="Edite el texto completo. El número de entrevistas se agregará automáticamente. Deje vacío para usar el texto por defecto."
      [rows]="3"
      [value]="viewModel().data.parrafoSeccion3_fuentes_primarias || ''"
      (valueChange)="onFieldChange('parrafoSeccion3_fuentes_primarias', $event)">
    </app-paragraph-editor>

    <app-paragraph-editor
      fieldId="parrafoSeccion3_fuentes_secundarias"
      label="B. Fuentes Secundarias - Texto Introductorio"
      hint="Edite el texto completo. Deje vacío para usar el texto por defecto."
      [rows]="2"
      [value]="viewModel().data.parrafoSeccion3_fuentes_secundarias || ''"
      (valueChange)="onFieldChange('parrafoSeccion3_fuentes_secundarias', $event)">
    </app-paragraph-editor>

    <!-- ✅ TABLA EDITABLE DE ENTREVISTADOS -->
    <div class="form-field" style="margin-top: 20px;">
      <label class="label">
        Lista de Entrevistados
        <span class="badge badge-info" style="margin-left: 8px;">{{ obtenerTablaEntrevistados().length }} entrevistados</span>
      </label>
      <div class="entrevistados-editor">
        <div *ngIf="obtenerTablaEntrevistados().length === 0" class="alert alert-info">
          No hay entrevistados registrados. Use el botón "Agregar entrevistado" para comenzar.
        </div>
        
        <div class="table-responsive" *ngIf="obtenerTablaEntrevistados().length > 0">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Nombres y Apellidos</th>
                <th>Cargo u Ocupación</th>
                <th>Organización</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entrevistado of obtenerTablaEntrevistados(); let i = index">
                <td>
                  <input 
                    type="text" 
                    class="form-control form-control-sm"
                    [value]="entrevistado.nombre || ''"
                    (change)="actualizarEntrevistado(i, 'nombre', $event)"
                    placeholder="Nombre completo">
                </td>
                <td>
                  <input 
                    type="text" 
                    class="form-control form-control-sm"
                    [value]="entrevistado.cargo || ''"
                    (change)="actualizarEntrevistado(i, 'cargo', $event)"
                    placeholder="Cargo u ocupación">
                </td>
                <td>
                  <input 
                    type="text" 
                    class="form-control form-control-sm"
                    [value]="entrevistado.organizacion || ''"
                    (change)="actualizarEntrevistado(i, 'organizacion', $event)"
                    placeholder="Organización">
                </td>
                <td>
                  <button 
                    type="button"
                    class="btn btn-sm btn-danger"
                    (click)="eliminarEntrevistado(i)"
                    title="Eliminar este entrevistado">
                    ✕ Eliminar
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <button 
          type="button"
          class="btn btn-sm btn-success"
          (click)="agregarEntrevistado()"
          style="margin-top: 12px; padding: 10px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          + Agregar entrevistado
        </button>
      </div>
    </div>

    <!-- ✅ FASE 1: Interfaz de edición de fuentes secundarias -->
    <div class="form-field" style="margin-top: 20px;">
      <label class="label">
        B. Fuentes Secundarias - Lista
        <span class="badge badge-info" style="margin-left: 8px;">{{ obtenerFuentesSecundariasParaEditar().length }} fuentes</span>
      </label>
      <div class="fuentes-secundarias-editor">
        <div *ngIf="obtenerFuentesSecundariasParaEditar().length === 0" class="alert alert-info">
          No hay fuentes secundarias registradas. Use el botón "Agregar fuente" para comenzar.
        </div>
        
        <div *ngFor="let fuente of obtenerFuentesSecundariasParaEditar(); let i = index" class="fuente-item" style="display: flex; gap: 8px; margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 4px; border-left: 3px solid #007bff;">
          <div style="flex: 1;">
            <input 
              type="text" 
              class="form-control" 
              [value]="fuente"
              (change)="onFuenteInputChange(i, $event)"
              (blur)="onFuenteInputChange(i, $event)"
              placeholder="Ingrese la fuente secundaria"
              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <button 
            type="button"
            class="btn btn-sm btn-danger"
            (click)="eliminarFuenteSecundaria(i)"
            title="Eliminar esta fuente"
            style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ✕ Eliminar
          </button>
        </div>
        
        <button 
          type="button"
          class="btn btn-sm btn-success"
          (click)="agregarFuenteSecundaria()"
          style="margin-top: 12px; padding: 10px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          + Agregar fuente
        </button>
      </div>
    </div>

    <div class="form-field" style="margin-top: 20px;">
      <label class="label">Fotografías</label>
      <app-image-upload
        [fotografias]="fotografiasSeccion3"
        [sectionId]="seccionId"
        [photoPrefix]="PHOTO_PREFIX"
        [permitirMultiples]="true"
        labelTitulo="Título de la fotografía"
        labelFuente="Fuente de la fotografía"
        labelImagen="Fotografía - Imagen"
        placeholderTitulo="Ej: Fotografía de la sección 3"
        placeholderFuente="Ej: GEADES, 2024"
        tituloDefault="Sección 3"
        fuenteDefault="GEADES, 2024"
        [requerido]="false"
        (fotografiasChange)="onFotografiasChange($event)">
      </app-image-upload>
    </div>
  </div>
</div>
