<div *ngIf="!modoFormulario">
<h5>A.1.1. Institucionalidad local</h5>

<!-- Párrafo informativo -->
<p class="text-justify" *ngIf="obtenerParrafoInstitucionalidad(); else institucionalidadDefault">
    {{ obtenerParrafoInstitucionalidad() }}
</p>
  <ng-template #institucionalidadDefault>
      <p class="text-justify">Dentro de los límites de la CC <span [appDataSource]="'section'">{{ obtenerNombreComunidadActual() }}</span> se hallan instituciones que, además de la comunidad campesina en sí, también ejercen funciones dentro del territorio y coadyuvan en el desarrollo socioeconómico de la capital administrativa comunal y de sus diferentes sectores. Cabe destacar la presencia de diversos programas sociales (como Pensión 65, Juntos o Qali Warma), así como la existencia de una Junta Administradora de Servicios de Saneamiento (JASS).</p>
  </ng-template>

  <app-table-wrapper [title]="(datos.tituloInstituciones || 'Instituciones existentes – CC ' + obtenerNombreComunidadActual())" sectionId="3.1.4.A.1.1">
  <table class="table-container">
      <thead>
          <tr>
              <th class="table-header">Categoría</th>
              <th class="table-header">SI/NO</th>
              <th class="table-header">Nombre</th>
              <th class="table-header">Comentario</th>
          </tr>
      </thead>
      <tbody>
          <tr *ngFor="let institucion of (datos.tablepagina6 || [])">
              <td class="table-cell"><span *ngIf="institucion.categoria && institucion.categoria !== '____'" [appDataSource]="'manual'">{{ institucion.categoria }}</span><span *ngIf="!institucion.categoria || institucion.categoria === '____'">____</span></td>
              <td class="table-cell"><span *ngIf="institucion.respuesta && institucion.respuesta !== '____'" [appDataSource]="'manual'">{{ institucion.respuesta }}</span><span *ngIf="!institucion.respuesta || institucion.respuesta === '____'">____</span></td>
              <td class="table-cell"><span *ngIf="institucion.nombre && institucion.nombre !== '____' && institucion.nombre !== '–'" [appDataSource]="'manual'">{{ institucion.nombre }}</span><span *ngIf="!institucion.nombre || institucion.nombre === '____' || institucion.nombre === '–'">{{ institucion.nombre || '____' }}</span></td>
              <td class="table-cell"><span *ngIf="institucion.comentario && institucion.comentario !== '____' && institucion.comentario !== '–'" [appDataSource]="'manual'">{{ institucion.comentario }}</span><span *ngIf="!institucion.comentario || institucion.comentario === '____' || institucion.comentario === '–'">{{ institucion.comentario || '____' }}</span></td>
          </tr>
          <tr *ngIf="!datos.tablepagina6 || datos.tablepagina6.length === 0">
              <td class="table-cell">____</td>
              <td class="table-cell">____</td>
              <td class="table-cell">____</td>
              <td class="table-cell">____</td>
          </tr>
      </tbody>
  </table>
  <p class="source">Fuente:<span *ngIf="datos.fuenteInstituciones && datos.fuenteInstituciones !== '____'" [appDataSource]="'fuenteInstituciones' | dataSource">{{ datos.fuenteInstituciones }}</span><span *ngIf="!datos.fuenteInstituciones || datos.fuenteInstituciones === '____'">GEADES (2024)</span></p>
  </app-table-wrapper>

<!-- Vista previa de fotografías (solo lectura) -->
<app-image-upload
    [permitirMultiples]="true"
    [modoVista]="true"
    [fotografias]="fotografiasVista"
    [sectionId]="seccionId"
    [photoPrefix]="PHOTO_PREFIX"
    [mostrarTitulo]="true"
    [mostrarFuente]="true"
    [mostrarNumero]="true"
    [tituloDefault]="'Local Comunal de la CC ' + obtenerNombreComunidadActual()"
    [fuenteDefault]="'GEADES, 2024'">
</app-image-upload>
</div>

<div *ngIf="modoFormulario" class="seccion-formulario-content">
  <div class="form-group-section">
    <h4 class="section-title">A.1.1. Institucionalidad local</h4>
    
    <app-paragraph-editor
      fieldId="parrafoSeccion5_institucionalidad"
      label="Párrafo de Institucionalidad"
      hint="Edite el texto completo. Deje vacío para usar el texto por defecto."
      [rows]="4"
      [value]="obtenerParrafoInstitucionalidad()"
      (valueChange)="onFieldChange('parrafoSeccion5_institucionalidad', $event)">
    </app-paragraph-editor>

    <div class="form-field">
      <label class="label">Título de la Tabla</label>
      <input type="text" class="input" placeholder="Ej: Instituciones existentes - CC Ayroca"
        [value]="datos.tituloInstituciones || 'Instituciones existentes - CC ' + (datos.grupoAISD || 'Ayroca')"
        (input)="onFieldChange('tituloInstituciones', $any($event.target).value)">
    </div>

    <div class="form-field">
      <label class="label">Fuente de la Tabla</label>
      <input type="text" class="input" placeholder="Ej: GEADES (2024)"
        [value]="datos.fuenteInstituciones || 'GEADES (2024)'"
        (input)="onFieldChange('fuenteInstituciones', $any($event.target).value)">
    </div>

    <div class="form-field">
      <label class="label">Tabla de Instituciones</label>
      <div class="table-editor">
        <table class="editor-table">
          <thead>
            <tr>
              <th>Categoría</th>
              <th>SI/NO</th>
              <th>Nombre</th>
              <th>Comentario</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let institucion of (datos.tablepagina6 || []); let i = index">
              <td>
                <input type="text" class="table-input" 
                  [value]="institucion.categoria || ''"
                  (input)="actualizarInstitucion(i, 'categoria', $any($event.target).value)"
                  placeholder="Categoría">
              </td>
              <td>
                <select class="table-input" 
                  [value]="institucion.respuesta || ''"
                  (change)="actualizarInstitucion(i, 'respuesta', $any($event.target).value)">
                  <option value="">--</option>
                  <option value="SI">SI</option>
                  <option value="NO">NO</option>
                </select>
              </td>
              <td>
                <textarea class="table-input" rows="2"
                  [value]="institucion.nombre || ''"
                  (input)="actualizarInstitucion(i, 'nombre', $any($event.target).value)"
                  placeholder="Nombre (puede ser múltiples líneas)"></textarea>
              </td>
              <td>
                <textarea class="table-input" rows="2"
                  [value]="institucion.comentario || ''"
                  (input)="actualizarInstitucion(i, 'comentario', $any($event.target).value)"
                  placeholder="Comentario"></textarea>
              </td>
              <td>
                <button type="button" class="btn-icon" (click)="eliminarInstitucion(i)" *ngIf="(datos.tablepagina6 || []).length > 1" title="Eliminar fila">
                  ×
                </button>
              </td>
            </tr>
            <tr *ngIf="!datos.tablepagina6 || datos.tablepagina6.length === 0">
              <td colspan="5" style="text-align: center; padding: 10px;">
                <button type="button" class="btn btn-secondary" (click)="inicializarInstituciones()">
                  Agregar Primera Institución
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button type="button" class="btn btn-secondary" (click)="agregarInstitucion()" style="margin-top: 10px;">
        + Agregar Institución
      </button>
    </div>

    <div class="form-field" style="margin-top: 20px;">
      <label class="label">Fotografías</label>
      <app-image-upload
        [fotografias]="fotografiasFormMulti"
        [sectionId]="seccionId"
        [photoPrefix]="PHOTO_PREFIX"
        [permitirMultiples]="true"
        labelTitulo="Título de la fotografía"
        labelFuente="Fuente de la fotografía"
        labelImagen="Fotografía - Imagen"
        placeholderTitulo="Ej: Local Comunal de la CC Ayroca"
        placeholderFuente="Ej: GEADES, 2024"
        tituloDefault="Local Comunal de la CC Ayroca"
        fuenteDefault="GEADES, 2024"
        [requerido]="true"
        (fotografiasChange)="onFotografiasChange($event)">
      </app-image-upload>
    </div>
  </div>
</div>
